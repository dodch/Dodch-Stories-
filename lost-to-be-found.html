<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>lost to be found</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Basic Styling --- */
        * {
            box-sizing: border-box;
        }

        html {
            height: 100%; /* Ensures html fills the viewport */
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            min-height: 100vh; /* Body should be at least viewport height, and grow with content */
            position: relative;
            z-index: 1;
            transition: color 0.5s ease;
            /* No background on body here, it's for the fixed-background div */
        }

        /* --- LOADING SCREEN OVERLAY (fixed on top) --- */
        #loading-screen {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.9);
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          z-index: 10000;
          transition: opacity 0.5s ease;
        }

        #loading-screen.hidden {
          opacity: 0;
          pointer-events: none;
        }

        /* --- LOADING INDICATOR CONTAINER (holds hearts) --- */
        .loading-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }

        /* --- LOADING HEART ANIMATION --- */
        .loading-indicator span {
            display: inline-block;
            width: 15px;
            height: 15px;
            margin: 0 5px;
            color: white;
            font-size: 15px;
            opacity: 0;
            transform: scale(0.5);
            animation: pulse-heart 1.4s ease-in-out infinite;
        }

        .loading-indicator span:nth-child(1) { animation-delay: 0s; }
        .loading-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .loading-indicator span:nth-child(3) { animation-delay: 0.4s; }
        .loading-indicator span:nth-child(4) { animation-delay: 0.6s; }
        .loading-indicator span:nth-child(5) { animation-delay: 0.8s; }


        @keyframes pulse-heart {
            0% { opacity: 0; transform: scale(0.5); }
            50% { opacity: 1; transform: scale(1.1); }
            100% { opacity: 0; transform: scale(0.5); }
        }


        /* --- LOADING PERCENTAGE TEXT --- */
        .loading-percentage {
          color: #fff;
          font-size: 24px;
          font-family: "Ubuntu", sans-serif;
          text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }


         /* --- Wrapper for main page content --- */
        #page-content-wrapper {
            transition: filter 0.5s ease-in-out;
            position: relative;
            z-index: 0;
            width: 100%;
            min-height: 100vh; /* Important: Ensures the wrapper stretches to at least viewport height and grows */
            display: flex; /* Use flexbox to organize content vertically */
            flex-direction: column; /* Stack children vertically */
        }

        body.loading #page-content-wrapper {
            filter: blur(15px);
            pointer-events: none;
        }

        /* --- FIXED BACKGROUND STYLES --- */
        .fixed-background {
            position: fixed; /* Fixed to the viewport */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%; /* This is height of the viewport */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            z-index: -1; /* Place behind other content */
            transition: opacity 0.5s ease;
        }

        .fixed-background.light-background {
             background-image: url('https://i.ibb.co/W4PTCf4P/F59-EDCDE-25-A7-4-E02-BEBF-16-F94-CEE075-E.png');
             opacity: 1;
        }

        .fixed-background.dark-background {
             background-image: url("https://i.ibb.co/4Z82GLJt/EF83-F245-8482-467-E-AA8-A-AA50-CB9-E7778.png");
             opacity: 0;
        }

        body.dark-mode .fixed-background.light-background {
            opacity: 0;
        }
         body.dark-mode .fixed-background.dark-background {
            opacity: 1;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: scale(1);
            }
            to {
                opacity: 0;
                transform: scale(0.9);
            }
        }

        .blur-effect {
            backdrop-filter: blur(4px);
            transition: background-color 0.5s ease;
        }

        .blur-effect {
            background-color: rgba(255, 255, 255, 0.7);
        }

        body.dark-mode .blur-effect {
            background-color: rgba(31, 41, 55, 0.9);
        }

        body:not(.dark-mode) .glow {
            box-shadow: 0 0 15px 3px rgba(255, 215, 0, 0.9);
             transition: box-shadow 0.3s ease;
        }

        body.dark-mode .glow {
            box-shadow: 0 0 10px rgba(192, 132, 252, 0.8);
             transition: box-shadow 0.3s ease;
        }

        button {
             transition: color 0.3s ease, background-color 0.3s ease, transform 0.1s ease-out, box-shadow 0.3s ease;
        }

        button.tapped {
            transform: scale(0.97);
        }

        .shadow-lg-custom {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        .fade-out {
            animation: fadeOut 0.3s ease-in-out;
        }
        .glow-word {
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
        }

       #content {
            padding: 2rem;
            padding-top: 10rem; /* INCREASED PADDING TOP TO ACCOUNT FOR FIXED HEADER */
            position: relative;
            z-index: 1;
            margin-left: auto;
            margin-right: auto;
            max-width: 800px;
            border-radius: 0.5rem;
            margin-top: 1rem;
            margin-bottom: 1rem;
            background-color: transparent;
            transition: opacity 0.5s ease-in-out;
            opacity: 1;
            /* REMOVED ANY FIXED HEIGHTS OR OVERFLOW-Y HIDDEN */
            flex-grow: 1; /* Allow content to take up available space and push footer down */
        }

        #content.content-fading {
            opacity: 0;
        }

        #text span {
            cursor: pointer;
            display: inline;
            transition: text-shadow 0.3s ease, color 0.3s ease, -webkit-text-fill-color 0.3s ease;
            opacity: 1;
            transform: none;
        }

        #text span:hover {
             color: #9333EA;
        }

        body:not(.dark-mode) #text span:not(.glow-word) {
             text-shadow: 0 0 1px rgba(0, 0, 0, 0.5);
             -webkit-text-stroke: none;
             text-stroke: none;
             -webkit-text-fill-color: initial;
             color: inherit;
        }

        body.dark-mode #text span:not(.glow-word) {
            text-shadow: 0 0 1px rgba(255, 255, 255, 0.5);
             -webkit-text-stroke: none;
             text-stroke: none;
             -webkit-text-fill-color: white;
             color: white;
        }

        #text span.glow-word {
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
            text-shadow: none !important;
             -webkit-text-stroke: none !important;
             text-stroke: none !important;
             -webkit-text-fill-color: initial !important;
             color: initial !important;
             opacity: 1 !important;
             transform: none !important;
             transition-delay: 0ms !important;
             transition-duration: 0.3s !important;
        }

        #save-progress-button {
            z-index: 60;
        }

         body.dark-mode #content h1 {
             color: white;
             transition: color 0.5s ease;
        }

         body:not(.dark-mode) #content h1 {
             color: inherit;
             transition: color 0.5s ease;
        }

        #popup > div {
             transition: background-color 0.5s ease, color 0.5s ease;
        }

        #text p {
            margin-bottom: 1rem;
        }

        @keyframes spin-once {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
        .animate-spin-once {
          animation: spin-once 0.5s ease-in-out;
        }

        /* Adjust footer positioning to prevent overlap, if it's not fixed */
        /* If these are fixed, they also need sufficient Z-index */
        .fixed.bottom-4.left-4, .fixed.bottom-4.right-4 {
            z-index: 50; /* Ensure these are above the background */
        }

        /* IMPORTANT: If you want content to scroll and footer to stick,
           the main content area needs to be Scrollable, and the footer
           needs to be outside of that scrollable area or positioned carefully.
           With fixed header/footer, content needs enough padding top/bottom.
        */
        .fixed.top-0.left-0.right-0 {
             z-index: 50; /* Ensure header is above content */
        }

    </style>
</head>
<body class="loading">
    <div id="loading-screen">
        <div class="loading-indicator">
            <span>‚ù§Ô∏è</span> <span>‚ù§Ô∏è</span> <span>‚ù§Ô∏è</span> <span>‚ù§Ô∏è</span> <span>‚ù§Ô∏è</span>
        </div>
        <div class="loading-percentage">0%</div>
    </div>

    <div class="fixed-background light-background"></div>
    <div class="fixed-background dark-background"></div>

    <div id="page-content-wrapper">

        <div id="raw-ar-text" style="display: none;">
            </div>
        <div id="raw-fr-text" style="display: none;">
            </div>
        <div id="raw-en-text" style="display: none;">
            I wish I were special. I wish I were more than what I am.

            Staring into the locked bathroom mirror, I whispered that to myself.

            There are moments when I try to look at my face with eyes that aren‚Äôt mine, hoping maybe then, just maybe, I‚Äôll understand how others see me.

            Because no matter how long I stare, I can never truly grasp the whole image of myself. My reflection is often a blur to me. I‚Äôve never really seen me.

            But maybe that‚Äôs not entirely bad. Because if I can‚Äôt see myself, if I don‚Äôt fully understand my own features, maybe there‚Äôs still room to grow. Maybe there‚Äôs a part of me waiting to be discovered, a hidden strength, a quiet beauty that I‚Äôve overlooked.

            I find myself constantly trying to decode the expressions in my eyes. Are they hopeful? Tired? Or do they hold a secret I haven't yet uncovered?

            The silence of the room amplifies these thoughts, making them echo within me. Each breath feels heavy, burdened by the weight of unspoken questions.

            Sometimes, I imagine stepping out of my skin, just for a moment, to observe myself from a distance. Would I be kind to the person I see? Would I offer words of encouragement, or simply a gentle understanding?

            It‚Äôs a strange feeling, this detachment from one's own image. As if I‚Äôm a character in a story, and I‚Äôm just trying to figure out who I‚Äôm supposed to be.

            Perhaps the answers aren‚Äôt in the mirror, but in the journey itself. In the small acts of kindness, the quiet moments of reflection, the persistent search for what makes me, me.

            And maybe, just maybe, when I finally stop searching, when I simply exist, I‚Äôll truly be found. The reflection might still be a blur, but the essence, the true self, will shine through.

            I try to find the lines of worry, the subtle hints of joy, the stories etched onto my face. But they always seem to elude me, like whispers carried on the wind.

            This quest for self-perception often leaves me feeling a bit adrift, as if I'm navigating a vast ocean without a compass. Every interaction, every glance, becomes a clue, a piece of a puzzle I'm desperately trying to solve.

            But there's also a strange comfort in this uncertainty. It means I'm not defined by a single image, a single moment. I am fluid, evolving, a work in progress. And in that, there's a unique kind of freedom.

            So I continue to stare, not for answers, but for the quiet acceptance of the unknown. For the beauty of becoming, rather than just being. And in that space, I find a glimmer of hope, a whisper of peace.
        </div>

        <div class="fixed top-0 left-0 right-0 flex flex-col items-start p-4 space-y-2 z-50">
             <div class="flex justify-center space-x-4 mb-2">
                <button
                    id="ar-button"
                    onclick="changeLanguage('ar')"
                    class="text-purple-600 px-6 py-2 rounded-full shadow-lg-custom transition duration-300 ease-in-out transform hover:scale-105 hover:text-purple-700 focus:outline-none blur-effect"
                >
                    ÿßŸÑÿπÿ±ÿ®Ÿäÿ©
                </button>
                <button
                    id="fr-button"
                    onclick="changeLanguage('fr')"
                    class="text-purple-600 px-6 py-2 rounded-full shadow-lg-custom transition duration-300 ease-in-out transform hover:scale-105 hover:text-purple-700 focus:outline-none blur-effect"
                >
                    Fran√ßais
                </button>
                <button
                    id="en-button"
                    onclick="changeLanguage('en')"
                    class="text-purple-600 px-6 py-2 rounded-full shadow-lg-custom transition duration-300 ease-in-out transform hover:scale-105 hover:text-purple-700 focus:outline-none blur-effect"
                >
                    English
                </button>
             </div>
             <button
                 id="back-home-button"
                 onclick="window.location.href='https://dodch.github.io/Dodch-Stories-/index.html'"
                 class="text-purple-600 px-4 py-1 text-sm rounded-full shadow-lg-custom transition duration-300 ease-in-out transform hover:scale-105 hover:text-purple-700 focus:outline-none blur-effect inline-flex items-center"
             >
                <span class="mr-1">&larr;</span> <span id="back-home-text">Back Home</span>
            </button>
        </div>


        <div id="content" class="rounded-lg mx-auto content-fading">
            <h1 id="title" class="text-3xl font-bold mb-4"></h1>
            <div id="text" class="text-lg leading-relaxed"></div>
        </div>

        <button
            id="save-progress-button"
            onclick="scrollToSavedWord()"
            class="fixed bottom-4 left-4 text-purple-600 px-6 py-2 rounded-full shadow-lg-custom transition duration-300 ease-in-out transform hover:scale-105 hover:text-purple-700 focus:outline-none blur-effect"
            style="z-index: 60;"
        >
            Saved Progress
        </button>

        <div id="popup" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
            <div class="p-4 rounded-lg shadow-lg w-64 blur-effect fade-in">
                <h2 id="popup-title" class="text-lg font-bold mb-2">Save Position</h2>
                <p id="popup-text" class="mb-4 text-sm"></p>
                <div class="flex justify-end space-x-2">
                    <button
                        onclick="savePosition()"
                        class="bg-green-500 text-white px-4 py-2 rounded-full focus:outline-none"
                    >
                        Save
                    </button>
                    <button
                        onclick="closePopup()"
                        class="bg-red-500 text-white px-4 py-2 rounded-full focus:outline-none"
                    >
                        Exit
                    </button>
                </div>
            </div>
        </div>

        <div class="fixed bottom-4 right-4 z-50">
            <button
                id="dark-mode-toggle-button"
                onclick="toggleDarkMode()"
                class="text-gray-600 w-10 h-10 flex items-center justify-center rounded-full shadow-lg-custom transition duration-300 ease-in-out transform hover:scale-105 hover:text-gray-700 focus:outline-none blur-effect"
            >
                <span id="dark-mode-icon">‚òÄÔ∏è</span>
            </button>
        </div>

    </div>
    <script>
        const loadingScreen = document.getElementById("loading-screen");
        const loadPercentageText = document.querySelector(".loading-percentage");
        const body = document.body;

        let currentLanguage = 'en';
        let allSavedProgress = {};
        let tempSavedWordId = '';
        let tempSavedWordText = '';
        let highlightedWordElement = null;
        let isDarkMode = false;

        const contentMap = {
            ar: {
                title: 'ÿ∂ÿßÿ¶ÿπ ŸÑÿ£Ÿàÿ¨ÿØ',
                rawTextId: 'raw-ar-text',
                saveProgress: 'ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ŸÇÿØŸÖ',
                savePosition: 'ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸàÿ∂ÿπ',
                save: 'ÿ≠ŸÅÿ∏',
                exit: 'ÿÆÿ±Ÿàÿ¨',
                atWord: 'ŸÉŸÑŸÖÿ©',
                positionSaved: 'ÿßŸÑŸÖŸàŸÇÿπ ŸÖÿ≠ŸÅŸàÿ∏',
                forWord: 'ŸÑŸÉŸÑŸÖÿ©',
                wordNotFound: 'ÿßŸÑŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸäŸáÿß ŸÅŸä ÿßŸÑŸÜÿµ ÿßŸÑÿ≠ÿßŸÑŸä.',
                noWordSaved: 'ŸÑŸÖ Ÿäÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿ£Ÿä ŸÉŸÑŸÖÿ© ŸÑŸáÿ∞Ÿá ÿßŸÑŸÑÿ∫ÿ© ÿ®ÿπÿØ',
                backHome: 'ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©'
            },
            fr: {
                title: 'Perdu √† trouver',
                rawTextId: 'raw-fr-text',
                saveProgress: 'Enregistrer le progr√®s',
                savePosition: 'Enregistrer la position',
                save: 'Enregistrer',
                exit: 'Sortir',
                atWord: 'mot',
                positionSaved: 'La position est enregistr√©e',
                forWord: 'pour le mot',
                wordNotFound: 'Le mot enregistr√© n\'a pas √©t√© trouv√© dans le texte actuel.',
                noWordSaved: 'Aucun mot n\'a √©t√© enregistr√© pour cette langue encore',
                backHome: 'Retour √† l\'accueil'
            },
            en: {
                title: 'lost to be found',
                rawTextId: 'raw-en-text',
                saveProgress: 'Saved Progress',
                savePosition: 'Save Position',
                save: 'Save',
                exit: 'Exit',
                atWord: 'word',
                positionSaved: 'Position saved',
                forWord: 'for the word',
                wordNotFound: 'Saved word not found in current text.',
                noWordSaved: 'No word has been saved for this language yet',
                backHome: 'Back Home'
            },
        };

        // Reverted: References to fixed background divs
        const lightBackgroundDiv = document.querySelector('.fixed-background.light-background');
        const darkBackgroundDiv = document.querySelector('.fixed-background.dark-background');

        const contentDiv = document.getElementById('content');
        const textElement = document.getElementById('text');
        const titleElement = document.getElementById('title');
        const backHomeButton = document.getElementById('back-home-button');
        const backHomeTextSpan = document.getElementById('back-home-text');


        function applyTextEffects() {
            const textSpans = textElement.querySelectorAll('span[id^="word-p"]');
            const isDarkModeActive = document.body.classList.contains('dark-mode');

            textSpans.forEach(span => {
                 if (!span.classList.contains('glow-word')) {
                     if (isDarkModeActive) {
                         span.style.textShadow = '0 0 1px rgba(255, 255, 255, 0.5)';
                         span.style.webkitTextStroke = 'none';
                         span.style.textStroke = 'none';
                         span.style.webkitTextFillColor = 'white';
                         span.style.color = 'white';
                     } else {
                         span.style.textShadow = '0 0 1px rgba(0, 0, 0, 0.5)';
                         span.style.webkitTextStroke = 'none';
                         span.style.textStroke = 'none';
                         span.style.webkitTextFillColor = 'initial';
                         span.style.color = 'inherit';
                     }
                 }
             });
        }

        function clearSavedProgress() {
             delete allSavedProgress[currentLanguage];
             localStorage.setItem('allSavedProgress', JSON.stringify(allSavedProgress));

             if (highlightedWordElement) {
                highlightedWordElement.classList.remove('bg-yellow-200', 'bg-yellow-600', 'rounded', 'glow-word');
                applyTextEffects();
                highlightedWordElement = null;
             }
             console.log(`Saved progress for ${currentLanguage.toUpperCase()} cleared.`);
        }


        function changeLanguage(lang, fromLoad = false) {
            if (contentDiv.classList.contains('content-fading') && !fromLoad) {
                 return;
            }
            if (currentLanguage === lang && !fromLoad) {
                 return;
            }

            currentLanguage = lang;

            if (!fromLoad) {
                 localStorage.setItem('preferredLanguage', lang);
            }


            const content = contentMap[lang];

            contentDiv.classList.add('content-fading');

            const rawTextElement = document.getElementById(content.rawTextId);
            const rawText = rawTextElement ? rawTextElement.textContent.trim() : '';

            setTimeout(() => {
                titleElement.textContent = content.title;
                backHomeTextSpan.textContent = content.backHome;


                if (lang === 'ar') {
                    contentDiv.dir = 'rtl';
                    textElement.style.textAlign = 'right';
                } else {
                    contentDiv.dir = 'ltr';
                    textElement.style.textAlign = 'left';
                }

                textElement.innerHTML = '';

                if (rawText) {
                    const paragraphs = rawText.split('\n\n');

                    paragraphs.forEach((paragraph, pIndex) => {
                         const lines = paragraph.split('\n');

                         lines.forEach((line, lIndex) => {
                             const trimmedLine = line.trim();

                             if (trimmedLine === '') {
                                  const br = document.createElement('br');
                                  textElement.appendChild(br);
                             } else {
                                 const pElement = document.createElement('p');
                                 pElement.classList.add('mb-4', 'text-lg', 'leading-relaxed');


                                 const wordsAndSpaces = trimmedLine.match(/\S+|\s+|[.,!?;:]/g);

                                 if (wordsAndSpaces) {
                                     wordsAndSpaces.forEach((part, partIndex) => {
                                         if (part.trim() === '' && !/[.,!?;:]/.test(part)) {
                                             pElement.appendChild(document.createTextNode(part));
                                         } else {
                                             const span = document.createElement('span');
                                             span.textContent = part;
                                             span.classList.add('cursor-pointer');

                                             const uniqueId = `word-p${pIndex}-l${lIndex}-part${partIndex}`;
                                             span.id = uniqueId;

                                             span.onclick = () => handleWordClick(uniqueId, span.textContent.trim());

                                             pElement.appendChild(span);
                                         }
                                     });
                                 }
                                 textElement.appendChild(pElement);
                             }
                         });
                    });
                } else {
                     const noTextElement = document.createElement('p');
                     noTextElement.classList.add('text-center', 'text-xl', 'text-gray-500');
                     noTextElement.textContent = `No text available for ${lang.toUpperCase()}. Please add content to the raw text div.`;
                     textElement.appendChild(noTextElement);
                     console.warn(`No raw text found for language: ${lang}`);
                }


                document.getElementById('save-progress-button').textContent = content.saveProgress;
                document.getElementById('popup-title').textContent = content.savePosition;
                document.getElementById('popup').querySelector('.bg-green-500').textContent = content.save;
                document.getElementById('popup').querySelector('.bg-red-500').textContent = content.exit;

                document.getElementById('ar-button').classList.remove('glow');
                document.getElementById('fr-button').classList.remove('glow');
                document.getElementById('en-button').classList.remove('glow');
                document.getElementById(`${lang}-button`).classList.add('glow');

                 highlightWord();

                 const savedProgressForCurrentLang = allSavedProgress[currentLanguage];
                 if (fromLoad && savedProgressForCurrentLang && savedProgressForCurrentLang.id) {
                      setTimeout(() => {
                          scrollToSavedWord(false);
                      }, 100);
                 }

                contentDiv.classList.remove('content-fading');

                 if (isDarkMode) {
                     titleElement.style.color = 'white';
                 } else {
                      titleElement.style.color = 'inherit';
                 }

            }, 500);
        }

        function handleWordClick(spanId, wordText) {
            tempSavedWordId = spanId;
            tempSavedWordText = wordText;
            document.getElementById('popup-text').textContent = `${contentMap[currentLanguage].savePosition} ${contentMap[currentLanguage].atWord}: "${wordText}"?`;
            document.getElementById('popup').classList.remove('hidden');
            document.getElementById('popup').classList.remove('fade-out');
            document.getElementById('popup').classList.add('fade-in');
        }

        function closePopup() {
            document.getElementById('popup').classList.remove('fade-in');
            document.getElementById('popup').classList.add('fade-out');
            tempSavedWordId = '';
            tempSavedWordText = '';
            setTimeout(() => {
                document.getElementById('popup').classList.add('hidden');
            }, 300);
        }

        function savePosition() {
            if (tempSavedWordId) {
                allSavedProgress[currentLanguage] = {
                    id: tempSavedWordId,
                    text: tempSavedWordText
                };

                console.log(`${contentMap[currentLanguage].positionSaved} ${contentMap[currentLanguage].forWord}: "${tempSavedWordText}" (ID: ${tempSavedWordId}) in language "${currentLanguage}"`);

                localStorage.setItem('allSavedProgress', JSON.stringify(allSavedProgress));

                highlightWord();

            }
            closePopup();
        }

        function scrollToSavedWord(performChecks = true) {
            const savedProgressForCurrentLang = allSavedProgress[currentLanguage];

            if (!savedProgressForCurrentLang || !savedProgressForCurrentLang.id) {
                alert(contentMap[currentLanguage].noWordSaved);
                return;
            }

            const savedWordId = savedProgressForCurrentLang.id;
            const savedWordText = savedProgressForCurrentLang.text;

            const targetElement = document.getElementById(savedWordId);

            if (targetElement) {
                 highlightWord();

                 requestAnimationFrame(() => {
                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                 });

            } else {
                console.warn(`${contentMap[currentLanguage].wordNotFound} (ID: ${savedWordId}, Text: "${savedWordText}")`);
                if (performChecks) {
                    alert(`${contentMap[currentLanguage].wordNotFound} ("${savedWordText}")`);
                    const confirmClear = confirm(`Clear saved progress for ${currentLanguage.toUpperCase()}?`);
                    if (confirmClear) {
                        clearSavedProgress();
                    }
                } else {
                     console.warn(`Clearing saved progress for ${currentLanguage.toUpperCase()} due to missing element.`);
                     clearSavedProgress();
                }
            }
        }

       function highlightWord() {
           if (highlightedWordElement) {
               highlightedWordElement.classList.remove('bg-yellow-200', 'bg-yellow-600', 'rounded', 'glow-word');
               applyTextEffects();
               highlightedWordElement = null;
           }

           const savedProgressForCurrentLang = allSavedProgress[currentLanguage];

           if (!savedProgressForCurrentLang || !savedProgressForCurrentLang.id) {
               return;
           }

           const savedWordId = savedProgressForCurrentLang.id;

           const targetElement = document.getElementById(savedWordId);

           if (targetElement) {
               highlightedWordElement = targetElement;

               highlightedWordElement.classList.add('rounded', 'glow-word');

               if (document.body.classList.contains('dark-mode')) {
                   highlightedWordElement.classList.remove('bg-yellow-200');
                   highlightedWordElement.classList.add('bg-yellow-600');
               } else {
                   highlightedWordElement.classList.remove('bg-yellow-600');
                   highlightedWordElement.classList.add('bg-yellow-200');
               }

               highlightedWordElement.style.textShadow = 'none';
               highlightedWordElement.style.webkitTextStroke = 'none';
               highlightedWordElement.style.textStroke = 'none';
               highlightedWordElement.style.webkitTextFillColor = 'initial';
               highlightedWordElement.style.color = 'initial';

           } else {
               console.warn(`Element for saved word ID "${savedWordId}" not found for highlighting in language "${currentLanguage}".`);
           }
       }

        function toggleDarkMode() {
            const body = document.body;
            const languageButtons = document.querySelectorAll('#ar-button, #fr-button, #en-button');
            const saveButton = document.getElementById('save-progress-button');
            const darkModeToggleBtn = document.getElementById('dark-mode-toggle-button');
            const darkModeIcon = document.getElementById('dark-mode-icon');
            const popupDivInner = document.getElementById('popup').querySelector('div');
            const contentTitle = document.getElementById('title');

            isDarkMode = !isDarkMode;
            localStorage.setItem('darkModeEnabled', isDarkMode);

            darkModeToggleBtn.classList.add('animate-spin-once');
            darkModeToggleBtn.addEventListener('animationend', () => {
                darkModeToggleBtn.classList.remove('animate-spin-once');
            }, { once: true });


            if (isDarkMode) {
                body.classList.add('dark-mode');
                // These are now correctly manipulating the opacity of the fixed background divs
                lightBackgroundDiv.style.opacity = 0;
                darkBackgroundDiv.style.opacity = 1;

                languageButtons.forEach(button => {
                     button.classList.remove('text-purple-600', 'hover:text-purple-700');
                     button.classList.add('text-purple-300', 'hover:text-purple-400');
                });
                 saveButton.classList.remove('text-purple-600', 'hover:text-purple-700');
                 saveButton.classList.add('text-purple-300', 'hover:text-purple-400');

                 backHomeButton.classList.remove('text-purple-600', 'hover:text-purple-700');
                 backHomeButton.classList.add('text-purple-300', 'hover:text-purple-400');


                darkModeToggleBtn.classList.remove('text-gray-600', 'hover:text-gray-700');
                darkModeToggleBtn.classList.add('text-gray-400', 'hover:text-gray-300');

                darkModeIcon.textContent = 'üåô';

                popupDivInner.classList.remove('text-gray-800');
                popupDivInner.classList.add('text-white');

                contentTitle.style.color = 'white';

            } else {
                body.classList.remove('dark-mode');
                // These are now correctly manipulating the opacity of the fixed background divs
                lightBackgroundDiv.style.opacity = 1;
                darkBackgroundDiv.style.opacity = 0;

                 languageButtons.forEach(button => {
                     button.classList.remove('text-purple-300', 'hover:text-purple-400');
                     button.classList.add('text-purple-600', 'hover:text-purple-700');
                 });
                 saveButton.classList.remove('text-purple-300', 'hover:text-purple-400');
                 saveButton.classList.add('text-purple-600', 'hover:text-purple-700');

                 backHomeButton.classList.remove('text-purple-300', 'hover:text-purple-400');
                 backHomeButton.classList.add('text-purple-600', 'hover:text-purple-700');


                darkModeToggleBtn.classList.remove('text-gray-400', 'hover:text-gray-300');
                darkModeToggleBtn.classList.add('text-gray-600', 'hover:text-gray-700');

                darkModeIcon.textContent = '‚òÄÔ∏è';

                popupDivInner.classList.remove('text-white');
                popupDivInner.classList.add('text-gray-800');

                 contentTitle.style.color = 'inherit';
            }

             applyTextEffects();
             highlightWord();
        }

        const animatedButtons = document.querySelectorAll('button:not(#popup button):not(#dark-mode-toggle-button)');
        animatedButtons.forEach(button => {
            button.addEventListener('click', function() {
                 if (this.id !== 'back-home-button') {
                    this.classList.add('tapped');
                    setTimeout(() => {
                        this.classList.remove('tapped');
                    }, 100);
                 }
            });
        });


        let load = 0;
        let interval = setInterval(updateLoadingText, 30);

        function updateLoadingText() {
          load++;

          if (load > 99) {
            clearInterval(interval);
            loadPercentageText.innerText = '100%';
          } else {
            loadPercentageText.innerText = `${load}%`;
          }
        }

        window.addEventListener('load', () => {
             if (load < 100) {
                 loadPercentageText.innerText = '100%';
             }

            setTimeout(() => {
                body.classList.remove('loading');
                loadingScreen.classList.add('hidden');

                setTimeout(() => {
                    loadingScreen.remove();
                 }, 600);

            }, 500);
        });


        document.addEventListener('DOMContentLoaded', () => {
             const savedProgressJson = localStorage.getItem('allSavedProgress');
             try {
                 allSavedProgress = JSON.parse(savedProgressJson) || {};
             } catch (e) {
                 console.error("Failed to parse saved progress from localStorage:", e);
                 allSavedProgress = {};
                 localStorage.removeItem('allSavedProgress');
             }

             const savedDarkMode = localStorage.getItem('darkModeEnabled');
             if (savedDarkMode !== null) {
                 isDarkMode = JSON.parse(savedDarkMode);
             } else {
                 isDarkMode = false;
             }

             // Correctly set initial opacity for fixed backgrounds based on isDarkMode
             if (isDarkMode) {
                 lightBackgroundDiv.style.opacity = 0;
                 darkBackgroundDiv.style.opacity = 1;
                 body.classList.add('dark-mode'); // Also add the class for other CSS rules
             } else {
                 lightBackgroundDiv.style.opacity = 1;
                 darkBackgroundDiv.style.opacity = 0;
                 body.classList.remove('dark-mode'); // Ensure no dark mode class initially
             }

             // Now call toggleDarkMode to set the icon and button colors
             // Toggle it once to reflect the *correct* loaded state initially
             // We need to 'invert' isDarkMode here because toggleDarkMode will flip it again
             isDarkMode = !isDarkMode; // This ensures the first call sets it to the loaded/default value
             toggleDarkMode();


             const preferredLanguage = localStorage.getItem('preferredLanguage');
             let initialLangToLoad = 'en';

             if (preferredLanguage && contentMap[preferredLanguage]) {
                initialLangToLoad = preferredLanguage;
             }

             changeLanguage(initialLangToLoad, true);

        });

</script>
</body>
</html>
